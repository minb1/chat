<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chat Interface</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <!-- Include Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --header-height: 60px;
            --primary-color: #6e41e2;
            --secondary-color: #f5f5f7;
            --text-color: #333;
            --light-text: #6c757d;
            --border-color: #e0e0e0;
            --settings-sidebar-width: 250px; /* New: Width for left sidebar */
            --docs-sidebar-width: 300px; /* Default docs sidebar width */
        }

        body {
            background-color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* New: Settings Sidebar */
        .settings-sidebar {
            width: var(--settings-sidebar-width);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            background-color: var(--secondary-color);
            padding: 15px;
            min-width: 200px; /* Minimum width */
            max-width: 40%; /* Maximum width */
            display: flex;
            flex-direction: column;
            gap: 15px; /* Spacing between setting groups */
        }
        .settings-sidebar h5 {
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 1rem;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
         .settings-sidebar .form-label {
             font-weight: 500;
             font-size: 0.9rem;
             margin-bottom: 3px;
         }
         .settings-sidebar .form-select,
         .settings-sidebar .form-control,
         .settings-sidebar .form-check-input {
             font-size: 0.9rem;
         }
          .settings-sidebar .form-check-label {
             font-size: 0.9rem;
         }

        .main-content {
            flex: 1; /* Takes up remaining space */
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            min-width: 300px; /* Prevent main content from becoming too small */
        }

        /* Docs Sidebar (Right) */
        .docs-sidebar {
            width: var(--docs-sidebar-width);
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            background-color: var(--secondary-color);
            padding: 10px;
            min-width: 200px; /* Minimum sidebar width */
            max-width: 50%; /* Maximum sidebar width */
        }

        /* Divider styles (shared) */
        .divider {
            width: 8px;
            background-color: var(--border-color);
            cursor: col-resize;
            position: relative;
            flex-shrink: 0; /* Prevent dividers from shrinking */
        }
        .divider:hover, .divider.active {
            background-color: var(--primary-color);
        }
        .divider::after { /* Optional drag indicator */
            content: "â‹®";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .divider:hover::after, .divider.active::after {
            opacity: 1;
        }


        /* Chat Header Adjustments */
        .chat-header {
            height: var(--header-height);
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            flex-wrap: wrap; /* Allow wrapping if needed */
            gap: 15px; /* Add some gap between elements */
        }

        .chat-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-right: auto; /* Push other elements to the right */
        }
         /* Controls moved to sidebar, header simplified */


        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fff;
        }

        /* Message styles */
        .message { margin-bottom: 24px; max-width: 90%; display: flex; flex-direction: column; }
        .message-header { font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; }
        .user-message { align-items: flex-end; margin-left: auto; }
        .user-message .message-header { color: var(--primary-color); justify-content: flex-end; }
        .user-message .message-content { background-color: var(--primary-color); color: white; border-radius: 15px 15px 0 15px; padding: 10px 15px; text-align: left; }
        .bot-message { align-items: flex-start; margin-right: auto; }
        .bot-message .message-header { color: var(--primary-color); justify-content: flex-start; }
        .bot-message .message-content { background-color: var(--secondary-color); color: var(--text-color); border-radius: 15px 15px 15px 0; padding: 10px 15px; }
        .message-content { line-height: 1.5; word-wrap: break-word; }
        .message-content pre { background-color: #e9ecef; padding: 10px; border-radius: 5px; overflow-x: auto; font-family: monospace; }
        .message-content code { background-color: #e9ecef; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .message-content p { margin-bottom: 0.5rem; }
        .message-content ul, .message-content ol { padding-left: 20px; }


        /* Input container */
        .chat-input-container { padding: 16px; border-top: 1px solid var(--border-color); background-color: #fff; }
        .chat-input { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background-color: #fff; }
        .chat-input textarea { flex: 1; border: none; padding: 12px 16px; resize: none; font-size: 1rem; min-height: 56px; max-height: 200px; outline: none; }
        .chat-input button { background-color: var(--primary-color); color: white; border: none; padding: 0 20px; cursor: pointer; font-weight: 600; }
        .chat-input button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Welcome Screen */
        .welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; padding: 0 20px; }
        .welcome-screen h1 { margin-bottom: 24px; color: var(--primary-color); font-size: 2.5rem; }
        .welcome-screen p { margin-bottom: 32px; font-size: 1.2rem; color: var(--light-text); max-width: 600px; }
        .welcome-screen button { background-color: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .chat-interface { display: none; /* Hidden by default */ flex-direction:column; height:100%; /* Make chat interface take full height of main content */ }

        /* Sidebar Accordion Styling */
        .docs-sidebar h5 { padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .accordion-item { background-color: #fff; border: 1px solid var(--border-color); margin-bottom: 5px; border-radius: 4px; }
        .accordion-header { margin-bottom: 0; }
        .accordion-button { background-color: #f8f9fa; color: var(--text-color); font-weight: 500; font-size: 0.9rem; padding: 0.75rem 1rem; border-radius: 4px 4px 0 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .accordion-button:not(.collapsed) { color: var(--primary-color); background-color: #e7f1ff; box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125); }
        .accordion-button:focus { box-shadow: 0 0 0 0.2rem rgba(110, 65, 226, 0.25); z-index: 3; }
        .accordion-button::after { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%236e41e2'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e"); }
        .accordion-body { padding: 1rem; font-size: 0.85rem; line-height: 1.4; max-height: 300px; overflow-y: auto; }
        .accordion-body pre { background-color: #f1f1f1; padding: 8px; border-radius: 4px; font-size: 0.8rem; overflow-x: auto; }
        .accordion-body code { background-color: #f1f1f1; padding: 1px 3px; border-radius: 2px; font-size: 0.8rem; }

        /* Style for feedback buttons */
        .feedback-buttons {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            gap: 5px; /* Space between buttons */
            margin-top: 8px; /* Space above buttons */
            margin-bottom: -10px; /* Pull buttons up slightly */
        }
        .feedback-buttons button {
            padding: 2px 6px; /* Smaller padding */
            font-size: 0.75rem; /* Smaller font */
            line-height: 1; /* Adjust line height */
            opacity: 0.7; /* Slightly transparent */
            transition: opacity 0.2s;
        }
         .feedback-buttons button:hover {
             opacity: 1;
         }
        /* Style for disabled/clicked state */
         .feedback-buttons.submitted button {
            opacity: 0.4;
            cursor: default;
         }
         .feedback-buttons.submitted button.active {
            opacity: 0.8; /* Keep the selected one slightly more visible */
            font-weight: bold; /* Indicate selection */
         }
    </style>
</head>
<body>
<div class="app-container">
    <!-- Settings Sidebar (Left) -->
    <div class="settings-sidebar" id="settingsSidebar">
        <h5>Settings</h5>

        <!-- Model Selection -->
        <div>
            <label for="modelSelector" class="form-label">LLM Model</label>
            <select id="modelSelector" class="form-select form-select-sm">
                <option value="">Loading models...</option>
            </select>
        </div>

        <!-- Retrieval Settings -->
        <div>
             <label for="retrievalTopK" class="form-label">Retrieval Top K</label>
             <input type="number" class="form-control form-control-sm" id="retrievalTopK" value="50" min="1" max="50">
             <div class="form-text text-muted" style="font-size: 0.75rem;">Number of docs from vector DB.</div>
        </div>


        <!-- Reranker Settings -->
        <div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="useRerankerCheckbox" checked>
              <label class="form-check-label" for="useRerankerCheckbox">Use Reranker</label>
            </div>
            <div id="rerankerOptions" class="mt-2"> <!-- Show/hide options based on checkbox -->
                <label for="rerankerTopK" class="form-label">Reranker Top K</label>
                <input type="number" class="form-control form-control-sm" id="rerankerTopK" value="10" min="1" max="50">
                <div class="form-text text-muted" style="font-size: 0.75rem;">Number of docs after reranking.</div>
            </div>
        </div>

         <!-- ***** NEW: HyDE Setting ***** -->
        <div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="useHydeCheckbox"> <!-- Default off -->
                <label class="form-check-label" for="useHydeCheckbox">Use HyDE</label>
            </div>
            <div class="form-text text-muted" style="font-size: 0.75rem;">Generate hypothetical doc for retrieval.</div>
        </div>
        <!-- ***** END NEW: HyDE Setting ***** -->

        <!-- Spacer -->
        <div style="flex-grow: 1;"></div>

        <!-- Update Knowledge Button -->
         <div>
            <button id="updateKnowledgeBtn" class="btn btn-sm btn-secondary w-100">Update Knowledge Base</button>
         </div>
         <div id="chatSessionId" class="text-center" style="font-size: 0.8rem; color: #6c757d;">
             <!-- Session ID will be populated here -->
         </div>

    </div>

    <!-- Resizable divider (Optional - can add later if needed) -->
    <!-- <div class="divider" id="dividerLeft"></div> -->

    <!-- Main Content Area (Chat) -->
    <div class="main-content">
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen">
            <h1>Logius Standaarden Chat</h1>
            <p>Stel vragen over de Logius Standaarden en krijg direct antwoord.</p>
            <button id="startChatBtn">Start Chat</button>
        </div>
        <!-- Chat Interface -->
        <div class="chat-interface" id="chatInterface">
            <div class="chat-header">
                <div class="chat-title">Logius Standaarden Chat</div>
                 <!-- Controls moved to left sidebar -->
                 <!-- Chat Session ID moved to left sidebar -->
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Initial bot message -->
                <div class="message bot-message">
                    <div class="message-header"><i class="bi bi-robot me-2"></i> Assistant</div>
                    <div class="message-content" data-raw-text="Hallo, ik ben de Logius-assistent. Hoe kan ik u helpen?">Hallo, ik ben de Logius-assistent. Hoe kan ik u helpen?</div>
                     <!-- Feedback buttons added dynamically by JS for actual bot responses -->
                </div>
            </div>
            <div class="chat-input-container">
                <form id="chatForm">
                    <div class="chat-input">
                        <textarea id="userInput" placeholder="Stel een vraag over de Standaarden..." required></textarea>
                        <button type="submit"><i class="bi bi-send"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Resizable divider (Right) -->
    <div class="divider" id="dividerRight"></div>

    <!-- Docs Sidebar (Right) -->
    <div class="docs-sidebar" id="docsSidebar">
        <h5>Retrieved Docs</h5>
        <div class="accordion" id="docsAccordion">
            <!-- Accordion items will be injected here -->
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- DOM elements ---
        const welcomeScreen = document.getElementById('welcomeScreen');
        const chatInterface = document.getElementById('chatInterface');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const chatMessages = document.getElementById('chatMessages');
        const startChatBtn = document.getElementById('startChatBtn');
        const chatSessionId = document.getElementById('chatSessionId');
        const modelSelector = document.getElementById('modelSelector');
        const docsAccordion = document.getElementById('docsAccordion');
        const dividerRight = document.getElementById('dividerRight');
        const docsSidebar = document.getElementById('docsSidebar');
        const appContainer = document.querySelector('.app-container');
        const updateKnowledgeBtn = document.getElementById('updateKnowledgeBtn');
        const useRerankerCheckbox = document.getElementById('useRerankerCheckbox');
        const rerankerOptions = document.getElementById('rerankerOptions');
        const retrievalTopKInput = document.getElementById('retrievalTopK');
        const rerankerTopKInput = document.getElementById('rerankerTopK');
        const settingsSidebar = document.getElementById('settingsSidebar');
        const useHydeCheckbox = document.getElementById('useHydeCheckbox');


        let currentChatId = null;

        // --- Function to load models ---
        function loadModels() {
            fetch('/api/chat/models/')
                .then(response => response.json())
                .then(models => {
                    modelSelector.innerHTML = '';
                    let isFirst = true;
                    for (const [modelKey, modelLabel] of Object.entries(models)) {
                        const option = document.createElement('option');
                        option.value = modelKey;
                        option.textContent = modelLabel;
                        modelSelector.appendChild(option);
                    }
                    const defaultModel = "gemini"; // Or your preferred default
                    if (modelSelector.querySelector(`option[value="${defaultModel}"]`)) {
                         modelSelector.value = defaultModel;
                    } else if (modelSelector.options.length > 0) {
                         modelSelector.selectedIndex = 0;
                    }
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    modelSelector.innerHTML = '<option value="">Error loading</option>';
                });
        }
        loadModels(); // Load models when DOM is ready

        // --- Auto-resize textarea ---
        userInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });
        userInput.addEventListener('focus', function () { this.dispatchEvent(new Event('input')); });
        userInput.addEventListener('blur', function () { this.dispatchEvent(new Event('input')); });


        // --- Show/Hide Reranker K based on checkbox ---
        function toggleRerankerOptions() {
            rerankerOptions.style.display = useRerankerCheckbox.checked ? 'block' : 'none';
        }
        useRerankerCheckbox.addEventListener('change', toggleRerankerOptions);
        toggleRerankerOptions(); // Initial check

        // --- Start a new chat session ---
         startChatBtn.addEventListener('click', function () {
            fetch('/api/chat/session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                 })
                .then(data => {
                    currentChatId = data.chat_id;
                    // Update session ID display in the settings sidebar
                    chatSessionId.textContent = `Session: ${currentChatId.substring(0, 8)}...`;
                    welcomeScreen.style.display = 'none';
                    // Make sure chat interface is flex for proper layout
                    chatInterface.style.display = 'flex';
                    userInput.focus();
                    // Clear previous chat messages and sidebar for new session
                    chatMessages.innerHTML = `<div class="message bot-message"><div class="message-header"><i class="bi bi-robot me-2"></i> Assistant</div><div class="message-content" data-raw-text="Hallo, ik ben de Logius-assistent. Hoe kan ik u helpen?">Hallo, ik ben de Logius-assistent. Hoe kan ik u helpen?</div></div>`;
                    docsAccordion.innerHTML = '';
                })
                .catch(error => {
                    console.error('Error starting chat session:', error);
                    chatSessionId.textContent = 'Error starting session';
                 });
        });


        // --- Handle chat form submission ---
        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const query = userInput.value.trim();
            if (!query || !currentChatId) return;

            addMessage(query, 'user');
            userInput.value = '';
            userInput.dispatchEvent(new Event('input'));
            userInput.focus();

            const thinkingMsgId = `thinking-${Date.now()}`;
            addMessage("...", 'bot', thinkingMsgId);

            userInput.disabled = true;
            chatForm.querySelector('button').disabled = true;

            // --- Get ALL settings ---
            const useReranker = useRerankerCheckbox.checked;
            const modelName = modelSelector.value;
            const useHyde = useHydeCheckbox.checked;
            const retrievalTopK = parseInt(retrievalTopKInput.value, 10) || 5; // Use default if invalid
            const rerankerTopK = parseInt(rerankerTopKInput.value, 10) || 10; // Use default if invalid


            fetch('/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    query: query,
                    chat_id: currentChatId,
                    model_name: modelName,
                    use_reranker: useReranker,
                    retrieval_top_k: retrievalTopK,
                    reranker_top_k: rerankerTopK,
                    use_hyde: useHyde
                })
            })
            .then(response => {
                 if (!response.ok) {
                    // Try to parse error from backend
                    return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
                 }
                 return response.json();
            })
            .then(data => {
                removeMessage(thinkingMsgId);
                if (data.error) {
                    addMessage("Error: " + data.error, 'bot'); // Show backend error
                } else {
                    // Add the actual bot response WITH feedback buttons
                    addMessage(data.response, 'bot');
                    if (data.docs) {
                        console.log("Received docs:", data.docs);
                        updateDocsSidebar(data.docs);
                    } else {
                        docsAccordion.innerHTML = '<p class="p-2 text-muted">No documents retrieved.</p>';
                    }
                }
            })
            .catch(error => {
                removeMessage(thinkingMsgId);
                console.error('Error fetching chat response:', error);
                addMessage(`Sorry, something went wrong: ${error.message}`, 'bot'); // Show specific error
            })
            .finally(() => {
                userInput.disabled = false;
                chatForm.querySelector('button').disabled = false;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                userInput.focus();
            });
        });

        // --- addMessage function (MODIFIED for feedback buttons) ---
        function addMessage(text, sender, id = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            if (id) messageDiv.id = id;

            const headerDiv = document.createElement('div');
            headerDiv.classList.add('message-header');
            const icon = document.createElement('i');
            icon.classList.add('bi', sender === 'user' ? 'bi-person' : 'bi-robot', 'me-2');
            if (sender === 'user') {
                headerDiv.appendChild(document.createTextNode('You'));
                headerDiv.appendChild(icon);
            } else {
                headerDiv.appendChild(icon);
                headerDiv.appendChild(document.createTextNode('Assistant'));
            }

            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            // Store the raw text for feedback, before markdown parsing
            contentDiv.dataset.rawText = text; // <-- Store raw text
            if (sender === 'bot' && text !== "...") {
                 // Ensure marked is loaded before calling parse
                 if (typeof marked !== 'undefined') {
                    contentDiv.innerHTML = marked.parse(text, { breaks: true });
                 } else {
                    console.warn("Marked library not loaded, displaying raw text.");
                    contentDiv.textContent = text; // Fallback
                 }
            } else {
                contentDiv.textContent = text;
            }

            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);

            // --- ADD FEEDBACK BUTTONS FOR BOT MESSAGES (excluding "...") ---
            if (sender === 'bot' && text !== "...") {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.classList.add('feedback-buttons');
                // Use data attributes for feedback type
                feedbackDiv.innerHTML = `
                    <button class="btn btn-sm btn-outline-success feedback-btn" data-feedback="helpful" title="Helpful answer">
                        <i class="bi bi-hand-thumbs-up"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning feedback-btn" data-feedback="unhelpful" title="Unhelpful answer">
                        <i class="bi bi-hand-thumbs-down"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger feedback-btn" data-feedback="false" title="False information">
                        <i class="bi bi-exclamation-octagon"></i>
                    </button>
                `;
                messageDiv.appendChild(feedbackDiv);
            }
            // --- END FEEDBACK BUTTONS ---

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
         }


        // --- removeMessage function ---
         function removeMessage(id) {
            const messageElement = document.getElementById(id);
            if (messageElement) messageElement.remove();
         }

        // --- updateDocsSidebar function ---
        function updateDocsSidebar(docs) {
            docsAccordion.innerHTML = '';
            if (!Array.isArray(docs) || docs.length === 0) {
                docsAccordion.innerHTML = '<p class="p-2 text-muted small">No relevant documents found.</p>';
                return;
            }
            let index = 0;
            const createAccordionItem = (title, fullPath, content, index, score = null) => {
                const accordionItem = document.createElement('div');
                accordionItem.classList.add('accordion-item');
                const headerId = `heading${index}`;
                const collapseId = `collapse${index}`;
                const safeContent = typeof content === 'string' ? content : 'Content unavailable';
                let parsedContent = `<pre>${safeContent.replace(/</g, "<").replace(/>/g, ">")}</pre>`; // Default safe fallback
                 if (typeof marked !== 'undefined') {
                    try {
                        // Use DOMPurify if available and needed for security with markdown
                        // parsedContent = DOMPurify.sanitize(marked.parse(safeContent, { breaks: true }));
                         parsedContent = marked.parse(safeContent, { breaks: true });
                    } catch (e) { console.error("Markdown parsing error:", e); }
                 }
                const scoreText = (typeof score === 'number' && !isNaN(score)) ? ` (Score: ${score.toFixed(2)})` : '';
                accordionItem.innerHTML = `
                    <h2 class="accordion-header" id="${headerId}">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}" title="${fullPath}">
                        ${title}${scoreText}
                      </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headerId}" data-bs-parent="#docsAccordion">
                      <div class="accordion-body">${parsedContent}</div>
                    </div>`;
                docsAccordion.appendChild(accordionItem);
            };

            docs.forEach(doc => {
                if (!doc || typeof doc !== 'object' || !doc.file_path || typeof doc.content !== 'string') return;
                const filePath = doc.file_path;
                const mdContent = doc.content;
                const rerankScore = doc.rerank_score;
                const pathParts = filePath.split(/[\\/]/);
                let fileName = pathParts.pop() || 'Unknown Document';
                fileName = fileName.replace(/\.[^/.]+$/, "");
                createAccordionItem(fileName, filePath, mdContent, index, rerankScore);
                index++;
            });
         }


        // --- getCookie function ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // --- Resizable Divider Logic (Docs Sidebar - Right) ---
        let isResizingRight = false;
        let lastDownXRight = 0;

        dividerRight.addEventListener('mousedown', function (e) {
            isResizingRight = true;
            lastDownXRight = e.clientX;
            dividerRight.classList.add('active');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', function (e) {
            // Right Divider Logic
            if (isResizingRight) {
                const containerWidth = appContainer.offsetWidth;
                const delta = e.clientX - lastDownXRight;
                let sidebarWidth = docsSidebar.offsetWidth - delta; // Decrease width if mouse moves left

                const minWidth = 200;
                const settingsWidth = settingsSidebar.offsetWidth;
                const mainMinWidth = 300;
                const maxWidth = containerWidth - settingsWidth - mainMinWidth - dividerRight.offsetWidth;

                sidebarWidth = Math.max(minWidth, Math.min(sidebarWidth, maxWidth));

                docsSidebar.style.width = `${sidebarWidth}px`;
                document.documentElement.style.setProperty('--docs-sidebar-width', `${sidebarWidth}px`);
                lastDownXRight = e.clientX;
            }
        });

        document.addEventListener('mouseup', function () {
            if (isResizingRight) {
                 isResizingRight = false;
                 dividerRight.classList.remove('active');
                 document.body.style.cursor = 'default';
                 document.body.style.userSelect = 'auto';
                 localStorage.setItem('docsSidebarWidth', docsSidebar.style.width);
            }
        });

        // Optional: Double-click to reset divider
        dividerRight.addEventListener('dblclick', function () {
            const defaultWidth = '300px';
            docsSidebar.style.width = defaultWidth;
            document.documentElement.style.setProperty('--docs-sidebar-width', defaultWidth);
            localStorage.setItem('docsSidebarWidth', defaultWidth);
        });

        // Restore saved width
        const savedDocsWidth = localStorage.getItem('docsSidebarWidth');
        if (savedDocsWidth) {
            docsSidebar.style.width = savedDocsWidth;
            document.documentElement.style.setProperty('--docs-sidebar-width', savedDocsWidth);
        }
        // --- End Resizable Divider Logic ---

        // --- Test Update Knowledge button event listener ---
        updateKnowledgeBtn.addEventListener('click', function () {
            updateKnowledgeBtn.textContent = 'Updating...';
            updateKnowledgeBtn.disabled = true;
            fetch('/api/knowledge_base/build/', { method: 'GET' })
             .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
             .then(result => {
                  if (!result.ok) throw new Error(result.data.error || `HTTP error! status: ${result.status}`);
                  alert('Knowledge base update finished successfully.'); // Simple feedback
                  console.log('KB Update successful:', result.data);
             })
             .catch(error => {
                  console.error('Error updating knowledge base:', error);
                  alert(`Knowledge base update failed: ${error.message}`);
             })
             .finally(() => {
                  updateKnowledgeBtn.textContent = 'Update Knowledge Base';
                  updateKnowledgeBtn.disabled = false;
             });
        });
        // --- End Test Update Knowledge ---

        // --- NEW: Handle Feedback Button Clicks ---
        chatMessages.addEventListener('click', function(event) {
            // Use closest to handle clicks on the icon inside the button
            const button = event.target.closest('.feedback-btn');
            if (!button) return; // Click wasn't on a feedback button or its icon

            const feedbackType = button.dataset.feedback;
            const feedbackDiv = button.parentElement;
            const messageDiv = feedbackDiv.closest('.bot-message');
            const contentDiv = messageDiv.querySelector('.message-content');
            const llmResponse = contentDiv.dataset.rawText; // Get raw text stored earlier

            // Find the preceding user message to get the query
            let previousElement = messageDiv.previousElementSibling;
            let userQuery = null;
            while (previousElement) {
                if (previousElement.classList.contains('user-message')) {
                    const userContentDiv = previousElement.querySelector('.message-content');
                    if (userContentDiv) {
                        userQuery = userContentDiv.textContent; // Get user's query text
                    }
                    break; // Found the closest user message
                }
                previousElement = previousElement.previousElementSibling;
            }

            if (!userQuery) {
                console.warn("Could not find preceding user query for feedback.");
                // Optionally provide visual feedback (e.g., flash button red)
                return;
            }

            if (!currentChatId) {
                console.warn("No active chat session ID for feedback.");
                alert("Cannot submit feedback: No active session."); // User feedback
                return;
            }

            // Prevent multiple submissions for the same message
            if (feedbackDiv.classList.contains('submitted')) {
                console.log("Feedback already submitted for this message.");
                return;
            }

            // Disable buttons visually and functionally after click
            feedbackDiv.classList.add('submitted');
            button.classList.add('active'); // Highlight the clicked one
            feedbackDiv.querySelectorAll('.feedback-btn').forEach(btn => btn.disabled = true);

            // Send feedback to backend
            sendFeedback(currentChatId, userQuery, llmResponse, feedbackType, button); // Pass button for error handling
        });

        // --- NEW: Function to send feedback to API ---
        function sendFeedback(chatId, query, response, feedbackType, buttonElement) {
            console.log("Sending feedback:", { chatId, query: query.substring(0,100)+"...", response: response.substring(0,100)+"...", feedbackType });

            fetch('/api/feedback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    user_query: query,
                    llm_response: response,
                    feedback_type: feedbackType
                })
            })
            .then(response => {
                if (!response.ok) {
                    // Try to parse error from backend JSON response
                    return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
                }
                return response.json();
            })
            .then(data => {
                console.log("Feedback submitted successfully:", data);
                // Success: Keep buttons disabled and highlighted
            })
            .catch(error => {
                console.error('Error sending feedback:', error);
                alert(`Failed to submit feedback: ${error.message}`); // Inform user

                // Re-enable buttons on error to allow retry
                const feedbackDiv = buttonElement.parentElement;
                feedbackDiv.classList.remove('submitted');
                buttonElement.classList.remove('active'); // Remove highlight from clicked button
                feedbackDiv.querySelectorAll('.feedback-btn').forEach(btn => btn.disabled = false);

                // Optional: Add temporary visual error indication to the button
                buttonElement.classList.add('btn-outline-danger'); // Make border red
                buttonElement.classList.remove('btn-outline-success', 'btn-outline-warning'); // Remove original outline color
                setTimeout(() => {
                     // Reset to original outline color after a delay
                     buttonElement.classList.remove('btn-outline-danger');
                     if (feedbackType === 'helpful') buttonElement.classList.add('btn-outline-success');
                     else if (feedbackType === 'unhelpful') buttonElement.classList.add('btn-outline-warning');
                     else buttonElement.classList.add('btn-outline-danger'); // false info keeps danger outline
                }, 2500);
            });
        }

    }); // End DOMContentLoaded
</script>
<!-- Ensure Bootstrap JS is loaded -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>